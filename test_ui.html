<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pantheon ¬∑ Test Console</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface-hover: #22263a;
      --border: #2a2e3f;
      --text: #e4e6ed;
      --text-dim: #8b8fa3;
      --accent: #6c5ce7;
      --accent-glow: rgba(108, 92, 231, .25);
      --green: #00cec9;
      --red: #ff6b6b;
      --orange: #fdcb6e;
      --radius: 10px;
      --shadow: 0 4px 24px rgba(0, 0, 0, .35);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 28px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    header h1 {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -.3px;
    }

    header h1 span {
      color: var(--accent);
    }

    .server-bar {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .server-bar input {
      width: 260px;
      padding: 7px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      font-family: 'Inter', sans-serif;
    }

    .server-bar input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--red);
      flex-shrink: 0;
    }

    .dot.ok {
      background: var(--green);
    }

    /* ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ */
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 320px 1fr;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ */
    .sidebar {
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .sidebar-section {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-section h2 {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .8px;
      color: var(--text-dim);
      margin-bottom: 10px;
    }

    .item-card {
      padding: 10px 12px;
      margin-bottom: 6px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all .15s ease;
    }

    .item-card:hover {
      border-color: var(--accent);
      background: var(--surface-hover);
    }

    .item-card.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .item-card .name {
      font-size: 13px;
      font-weight: 600;
    }

    .item-card .meta {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 2px;
    }

    /* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
    button {
      font-family: 'Inter', sans-serif;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      transition: all .15s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      padding: 7px 14px;
    }

    .btn-primary:hover {
      filter: brightness(1.15);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-dim);
      border: 1px solid var(--border);
      padding: 6px 12px;
    }

    .btn-ghost:hover {
      color: var(--text);
      border-color: var(--text-dim);
    }

    .btn-sm {
      font-size: 11px;
      padding: 5px 10px;
    }

    .btn-danger {
      background: var(--red);
      color: #fff;
      padding: 6px 12px;
    }

    .btn-danger:hover {
      filter: brightness(1.15);
    }

    /* ‚îÄ‚îÄ‚îÄ Chat Area ‚îÄ‚îÄ‚îÄ */
    .chat-area {
      display: flex;
      flex-direction: column;
      background: var(--bg);
    }

    .chat-header {
      padding: 14px 24px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header h3 {
      font-size: 15px;
      font-weight: 600;
    }

    .chat-header .mode-badge {
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .5px;
    }

    .mode-manual {
      background: rgba(0, 206, 201, .15);
      color: var(--green);
    }

    .mode-roundtable {
      background: rgba(253, 203, 110, .15);
      color: var(--orange);
    }

    .mode-orchestrator {
      background: rgba(108, 92, 231, .15);
      color: var(--accent);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .msg {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 14px;
      font-size: 13.5px;
      line-height: 1.55;
      animation: fadeIn .25s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(6px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .msg.user {
      align-self: flex-end;
      background: var(--accent);
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .msg.assistant {
      align-self: flex-start;
      background: var(--surface);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .msg .agent-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .6px;
      color: var(--green);
      margin-bottom: 4px;
    }

    .msg.system {
      align-self: center;
      color: var(--text-dim);
      font-size: 12px;
      font-style: italic;
      padding: 6px 0;
    }

    .chat-input-area {
      padding: 16px 24px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }

    .chat-input-area input {
      flex: 1;
      padding: 10px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      font-family: 'Inter', sans-serif;
    }

    .chat-input-area input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .chat-input-area input::placeholder {
      color: var(--text-dim);
    }

    /* ‚îÄ‚îÄ‚îÄ Modals ‚îÄ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      animation: fadeIn .15s ease;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      width: 420px;
      max-width: 90vw;
      box-shadow: var(--shadow);
    }

    .modal-head {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      font-size: 15px;
      font-weight: 600;
    }

    .modal-body {
      padding: 16px 20px;
    }

    .modal-body label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .6px;
      color: var(--text-dim);
      margin-bottom: 4px;
      margin-top: 12px;
    }

    .modal-body label:first-child {
      margin-top: 0;
    }

    .modal-body input,
    .modal-body select,
    .modal-body textarea {
      width: 100%;
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      font-family: 'Inter', sans-serif;
    }

    .modal-body textarea {
      min-height: 70px;
      resize: vertical;
    }

    .modal-body input:focus,
    .modal-body select:focus,
    .modal-body textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .modal-foot {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* ‚îÄ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ‚îÄ */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--text-dim);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      opacity: .3;
    }

    .empty-state p {
      font-size: 13px;
    }

    /* ‚îÄ‚îÄ‚îÄ Log ‚îÄ‚îÄ‚îÄ */
    .log-panel {
      max-height: 120px;
      overflow-y: auto;
      padding: 8px 12px;
      font-size: 11px;
      background: var(--bg);
      border-top: 1px solid var(--border);
      color: var(--text-dim);
      font-family: monospace;
    }

    .log-panel .log-err {
      color: var(--red);
    }

    .log-panel .log-ok {
      color: var(--green);
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .6s linear infinite;
    }

    /* ‚îÄ‚îÄ‚îÄ Item Cards ‚îÄ‚îÄ‚îÄ */
    .item-card {
      position: relative;
    }

    .item-card .delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 107, 107, 0.1);
      color: var(--red);
      border-radius: 4px;
      font-size: 14px;
      opacity: 0;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .item-card:hover .delete-btn {
      opacity: 1;
    }

    .item-card .delete-btn:hover {
      background: var(--red);
      color: white;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>

  <!-- ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ -->
  <header>
    <h1><span>‚ö°</span> Pantheon Test Console</h1>
    <div class="server-bar">
      <div class="dot" id="statusDot"></div>
      <input id="apiUrl" placeholder="API Base URL">
      <button class="btn-primary btn-sm" onclick="checkHealth()">Connect</button>
    </div>
  </header>
  <script>
    document.getElementById("apiUrl").value = window.location.origin + "/api/v1";
  </script>

  <!-- ‚îÄ‚îÄ‚îÄ Main ‚îÄ‚îÄ‚îÄ -->
  <main>
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Agents -->
      <div class="sidebar-section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <h2>Agents</h2>
          <button class="btn-primary btn-sm" onclick="showModal('agentModal')">+ New</button>
        </div>
        <div id="agentList"></div>
      </div>
      <!-- Rooms -->
      <div class="sidebar-section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <h2>Rooms</h2>
          <button class="btn-primary btn-sm" onclick="showModal('roomModal')">+ New</button>
        </div>
        <div id="roomList"></div>
      </div>
      <!-- Room Agents -->
      <div class="sidebar-section" id="roomAgentsSection" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <h2>Room Agents</h2>
          <button class="btn-primary btn-sm" onclick="showModal('assignAgentModal')">+ Assign</button>
        </div>
        <div id="roomAgentList"></div>
      </div>
      <!-- Sessions -->
      <div class="sidebar-section" id="sessionsSection" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <h2>Sessions</h2>
          <button class="btn-primary btn-sm" onclick="createNewSession()">+ New</button>
        </div>
        <div id="sessionList"></div>
      </div>
    </div>

    <!-- Chat -->
    <div class="chat-area" id="chatArea">
      <div class="empty-state" id="emptyState">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
            d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <p>Select a room to start chatting</p>
      </div>
      <div id="chatView" style="display:none; flex:1; display:flex; flex-direction:column;">
        <div class="chat-header">
          <h3 id="chatRoomName">Room</h3>
          <select class="mode-badge" id="chatModeBadge" onchange="changeRoomMode()"
            style="background: var(--surface); color: var(--text); border: 1px solid var(--border); cursor: pointer;">
            <option value="manual">manual</option>
            <option value="roundtable">roundtable</option>
            <option value="orchestrator">orchestrator</option>
          </select>
        </div>
        <div class="chat-files" id="roomFiles"
          style="padding:10px 28px; border-bottom:1px solid var(--border); display:none; flex-wrap:wrap; gap:10px; font-size:12px; color:var(--text-dim);">
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
          <input id="chatInput" placeholder="Type a message... (use @agent_key for manual mode)"
            onkeydown="if(event.key==='Enter')sendMessage()">
          <input type="file" id="fileUploadInput" style="display:none" onchange="uploadFile()" accept=".txt,.md,.csv">
          <button class="btn-ghost" onclick="document.getElementById('fileUploadInput').click()" id="uploadBtn"
            title="Upload File (txt, md, csv)">üìé</button>
          <button class="btn-primary" onclick="sendMessage()" id="sendBtn">Send</button>
          <button class="btn-ghost" onclick="clearChat()">Clear</button>
        </div>
      </div>
    </div>
  </main>

  <div class="log-panel" id="logPanel"></div>

  <!-- ‚îÄ‚îÄ‚îÄ Agent Modal ‚îÄ‚îÄ‚îÄ -->
  <div class="modal-overlay hidden" id="agentModal">
    <div class="modal">
      <div class="modal-head">Create Agent</div>
      <div class="modal-body">
        <label>Name</label>
        <input id="agentName" placeholder="e.g. Code Writer">
        <label>Agent Key</label>
        <input id="agentKey" placeholder="e.g. code_writer">
        <label>Model Alias</label>
        <select id="agentModel">
          <option value="deepseek">deepseek (gemini-2.5-flash)</option>
          <option value="qwen">qwen</option>
          <option value="llama">llama</option>
          <option value="free">free</option>
          <option value="premium">premium</option>
        </select>
        <label>Role Prompt</label>
        <textarea id="agentPrompt" placeholder="You are a helpful assistant..."></textarea>
        <label>Tool Permissions</label>
        <div style="display:flex;gap:15px;margin-bottom:15px;font-size:13px;">
          <label style="display:flex;align-items:center;gap:5px;margin:0;font-weight:normal;">
            <input type="checkbox" id="toolSearch" value="search"> Web Search
          </label>
          <label style="display:flex;align-items:center;gap:5px;margin:0;font-weight:normal;">
            <input type="checkbox" id="toolFileRead" value="file_read"> File Read
          </label>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-ghost" onclick="hideModal('agentModal')">Cancel</button>
        <button class="btn-primary" onclick="createAgent()">Create</button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ Room Modal ‚îÄ‚îÄ‚îÄ -->
  <div class="modal-overlay hidden" id="roomModal">
    <div class="modal">
      <div class="modal-head">Create Room</div>
      <div class="modal-body">
        <label>Room Name</label>
        <input id="roomName" placeholder="e.g. Brainstorm Session">
        <label>Mode</label>
        <select id="roomMode">
          <option value="manual">Manual</option>
          <option value="roundtable">Roundtable</option>
          <option value="orchestrator">Orchestrator</option>
        </select>
        <label>Goal (optional)</label>
        <textarea id="roomGoal" placeholder="What should this room accomplish?"></textarea>
      </div>
      <div class="modal-foot">
        <button class="btn-ghost" onclick="hideModal('roomModal')">Cancel</button>
        <button class="btn-primary" onclick="createRoom()">Create</button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ Assign Agent Modal ‚îÄ‚îÄ‚îÄ -->
  <div class="modal-overlay hidden" id="assignAgentModal">
    <div class="modal">
      <div class="modal-head">Assign Agent to Room</div>
      <div class="modal-body">
        <label>Agent</label>
        <select id="assignAgentSelect"></select>
        <label>Position</label>
        <input id="assignPosition" type="number" value="1" min="1">
      </div>
      <div class="modal-foot">
        <button class="btn-ghost" onclick="hideModal('assignAgentModal')">Cancel</button>
        <button class="btn-primary" onclick="assignAgent()">Assign</button>
      </div>
    </div>
  </div>

  <script>
    const AUTH = "Bearer dev-override";
    let BASE = "http://127.0.0.1:8000/api/v1";

    let agents = [];
    let rooms = [];
    let activeRoom = null;
    let activeAgent = null;
    let activeSession = null;

    function clearChat() {
      if (!confirm("Clear message view? (This does not delete history from server)")) return;
      document.getElementById("chatMessages").innerHTML = "";
    }

    /* ‚îÄ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ */
    function api(method, path, body) {
      BASE = document.getElementById("apiUrl").value.replace(/\/+$/, "");
      const opts = { method, headers: { "Authorization": AUTH, "Content-Type": "application/json" } };
      if (body) opts.body = JSON.stringify(body);
      return fetch(BASE + path, opts);
    }

    function log(msg, cls = "") {
      const el = document.getElementById("logPanel");
      const line = document.createElement("div");
      line.className = cls;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      el.prepend(line);
    }

    function showModal(id) {
      document.getElementById(id).classList.remove("hidden");
      if (id === "assignAgentModal") populateAssignSelect();
    }
    function hideModal(id) { document.getElementById(id).classList.add("hidden"); }

    /* ‚îÄ‚îÄ‚îÄ Health Check ‚îÄ‚îÄ‚îÄ */
    function checkHealth() {
      api("GET", "/health").then(r => {
        if (r.ok) {
          document.getElementById("statusDot").classList.add("online");
          log("Connected to API", "log-ok");
          loadAgents(); // Added back based on original behavior
          loadRooms();  // Added back based on original behavior
        } else {
          document.getElementById("statusDot").classList.remove("online");
          log("API Offline (status code " + r.status + ")", "log-err");
        }
      }).catch(e => {
        document.getElementById("statusDot").classList.remove("online");
        log("Connection failed: " + e.message, "log-err");
      });
    }

    /* ‚îÄ‚îÄ‚îÄ Agents ‚îÄ‚îÄ‚îÄ */
    async function loadAgents() {
      try {
        const r = await api("GET", "/agents");
        if (!r.ok) { log("Failed to load agents: HTTP " + r.status + " - " + await r.text(), "log-err"); return; }
        const data = await r.json();
        agents = data.agents || [];
        renderAgents();
      } catch (e) { log("Failed to load agents: " + e.message, "log-err"); }
    }

    function renderAgents() {
      const el = document.getElementById("agentList");
      if (!agents.length) { el.innerHTML = '<div style="color:var(--text-dim);font-size:12px;">No agents yet</div>'; return; }
      el.innerHTML = agents.map(a => {
        const toolsStr = a.tool_permissions && a.tool_permissions.length ? ` ¬∑ [${a.tool_permissions.join(', ')}]` : '';
        return `
    <div class="item-card ${activeAgent && activeAgent.id === a.id ? 'active' : ''}" onclick="selectAgent('${a.id}')" title="${a.model_alias}">
      <div class="name">${a.name}</div>
      <div class="meta">@${a.agent_key} ¬∑ ${a.model_alias}${toolsStr}</div>
      <div class="delete-btn" onclick="deleteAgent('${a.id}', event)">√ó</div>
    </div>
  `}).join("");
    }

    async function createAgent() {
      const name = document.getElementById("agentName").value.trim();
      const key = document.getElementById("agentKey").value.trim();
      const model = document.getElementById("agentModel").value;
      const prompt = document.getElementById("agentPrompt").value.trim();

      const tools = [];
      if (document.getElementById("toolSearch").checked) tools.push("search");
      if (document.getElementById("toolFileRead").checked) tools.push("file_read");

      if (!name || !key) { log("Name and key are required", "log-err"); return; }
      try {
        const r = await api("POST", "/agents", {
          name, agent_key: key, model_alias: model,
          role_prompt: prompt || "You are a helpful assistant.",
          tool_permissions: tools
        });
        if (r.ok) {
          log(`Agent "${name}" created ‚úì`, "log-ok");
          hideModal("agentModal");
          document.getElementById("agentName").value = "";
          document.getElementById("agentKey").value = "";
          document.getElementById("agentPrompt").value = "";
          document.getElementById("toolSearch").checked = false;
          document.getElementById("toolFileRead").checked = false;
          loadAgents();
        } else {
          const err = await r.json();
          log("Create agent failed: " + JSON.stringify(err), "log-err");
        }
      } catch (e) { log("Create agent error: " + e.message, "log-err"); }
    }

    /* ‚îÄ‚îÄ‚îÄ Rooms ‚îÄ‚îÄ‚îÄ */
    async function loadRooms() {
      try {
        const r = await api("GET", "/rooms");
        if (!r.ok) { log("Failed to load rooms: HTTP " + r.status + " - " + await r.text(), "log-err"); return; }
        rooms = await r.json();
        renderRooms();
      } catch (e) { log("Failed to load rooms: " + e.message, "log-err"); }
    }

    function renderRooms() {
      const el = document.getElementById("roomList");
      if (!rooms.length) { el.innerHTML = '<div style="color:var(--text-dim);font-size:12px;">No rooms yet</div>'; return; }
      el.innerHTML = rooms.map(r => `
    <div class="item-card ${activeRoom && activeRoom.id === r.id ? 'active' : ''}" onclick="selectRoom('${r.id}')">
      <div class="name">${r.name}</div>
      <div class="meta">${r.current_mode}</div>
      <div class="delete-btn" onclick="deleteRoom('${r.id}', event)">√ó</div>
    </div>
  `).join("");
    }

    async function createRoom() {
      const name = document.getElementById("roomName").value.trim();
      const mode = document.getElementById("roomMode").value;
      const goal = document.getElementById("roomGoal").value.trim() || null;
      if (!name) { log("Room name is required", "log-err"); return; }
      if (mode === "orchestrator" && !goal) { log("A Goal/Theme is required for Orchestrator mode", "log-err"); return; }
      try {
        const r = await api("POST", "/rooms", { name, current_mode: mode, goal });
        if (r.ok) {
          log(`Room "${name}" created ‚úì`, "log-ok");
          hideModal("roomModal");
          document.getElementById("roomName").value = "";
          document.getElementById("roomGoal").value = "";
          loadRooms();
        } else {
          const err = await r.json();
          log("Create room failed: " + JSON.stringify(err), "log-err");
        }
      } catch (e) { log("Create room error: " + e.message, "log-err"); }
    }

    /* ‚îÄ‚îÄ‚îÄ Room / Agent Selection ‚îÄ‚îÄ‚îÄ */
    async function selectRoom(id) {
      activeRoom = rooms.find(r => r.id === id);
      activeAgent = null;
      renderRooms();
      renderAgents();
      document.getElementById("chatView").style.display = "flex";
      document.getElementById("emptyState").style.display = "none";
      document.getElementById("chatRoomName").textContent = activeRoom.name;
      document.getElementById("chatModeBadge").style.display = "inline-block";
      document.getElementById("chatModeBadge").value = activeRoom.current_mode;
      document.getElementById("chatModeBadge").className = "mode-badge mode-" + activeRoom.current_mode;
      document.getElementById("roomAgentsSection").style.display = "block";
      document.getElementById("sessionsSection").style.display = "block";
      document.getElementById("uploadBtn").style.display = "inline-block";
      loadRoomAgents(id);
      loadSessions("room", id);
      loadFiles();
    }

    async function selectAgent(id) {
      activeAgent = agents.find(a => a.id === id);
      activeRoom = null;
      renderRooms();
      renderAgents();
      document.getElementById("chatView").style.display = "flex";
      document.getElementById("emptyState").style.display = "none";
      document.getElementById("chatRoomName").textContent = activeAgent.name;
      document.getElementById("chatModeBadge").style.display = "none";
      document.getElementById("roomAgentsSection").style.display = "none";
      document.getElementById("sessionsSection").style.display = "block";
      document.getElementById("uploadBtn").style.display = "inline-block";
      document.getElementById("roomFiles").style.display = "none";
      loadSessions("agent", id);
    }

    async function changeRoomMode() {
      if (!activeRoom) return;
      const selectEl = document.getElementById("chatModeBadge");
      const newMode = selectEl.value;
      if (newMode === activeRoom.current_mode) return;

      try {
        const r = await api("PATCH", `/rooms/${activeRoom.id}/mode`, { mode: newMode });
        if (r.ok) {
          log(`Room mode changed to ${newMode} ‚úì`, "log-ok");
          activeRoom.current_mode = newMode;
          selectEl.className = "mode-badge mode-" + newMode;
          loadRooms(); // Refresh sidebar list
        } else {
          const err = await r.json();
          log("Change mode failed: " + JSON.stringify(err), "log-err");
          selectEl.value = activeRoom.current_mode; // revert
        }
      } catch (e) {
        log("Change mode error: " + e.message, "log-err");
        selectEl.value = activeRoom.current_mode; // revert
      }
    }

    async function deleteAgent(id, event) {
      if (event) event.stopPropagation();
      if (!confirm("Are you sure you want to delete this agent?")) return;
      try {
        const r = await api("DELETE", `/agents/${id}`);
        if (r.ok) {
          log("Agent deleted ‚úì", "log-ok");
          loadAgents();
        } else {
          log("Delete agent failed: " + r.status, "log-err");
        }
      } catch (e) { log("Delete agent error: " + e.message, "log-err"); }
    }

    async function deleteRoom(id, event) {
      if (event) event.stopPropagation();
      if (!confirm("Are you sure you want to delete this room?")) return;
      try {
        const r = await api("DELETE", `/rooms/${id}`);
        if (r.ok) {
          log("Room deleted ‚úì", "log-ok");
          if (activeRoom && activeRoom.id === id) {
            activeRoom = null;
            document.getElementById("chatView").style.display = "none";
            document.getElementById("emptyState").style.display = "flex";
            document.getElementById("roomAgentsSection").style.display = "none";
            document.getElementById("sessionsSection").style.display = "none";
          }
          loadRooms();
        } else {
          log("Delete room failed: " + r.status, "log-err");
        }
      } catch (e) { log("Delete room error: " + e.message, "log-err"); }
    }

    async function loadSessions(type, id) {
      try {
        const url = type === "room" ? `/rooms/${id}/sessions` : `/agents/${id}/sessions`;
        const r = await api("GET", url);
        const data = await r.json();
        renderSessions(data);
        if (data.length > 0 && !activeSession) {
          selectSession(data[0].id);
        } else if (data.length === 0) {
          activeSession = null;
          document.getElementById("chatMessages").innerHTML = '<div style="color:var(--text-dim);text-align:center;margin-top:20px;">No sessions yet. Click "+ New" to start.</div>';
        }
      } catch (e) { log("Load sessions error: " + e.message, "log-err"); }
    }

    function renderSessions(sessionList) {
      const el = document.getElementById("sessionList");
      if (!sessionList.length) { el.innerHTML = '<div style="color:var(--text-dim);font-size:12px;">No sessions</div>'; return; }
      el.innerHTML = sessionList.map(s => `
    <div class="item-card ${activeSession && activeSession.id === s.id ? 'active' : ''}" onclick="selectSession('${s.id}')">
      <div class="name">Session ${s.id.slice(0, 8)}</div>
      <div class="meta">${new Date(s.created_at).toLocaleString()}</div>
      <div class="delete-btn" onclick="deleteSession('${s.id}', event)">√ó</div>
    </div>
  `).join("");
    }

    async function selectSession(sessionId) {
      activeSession = { id: sessionId };
      renderSessions([]); // Trigger re-render with active class
      if (activeRoom) loadSessions("room", activeRoom.id);
      else if (activeAgent) loadSessions("agent", activeAgent.id);

      loadFiles();

      // Load messages
      try {
        const r = await api("GET", `/sessions/${sessionId}/messages?limit=100`);
        const data = await r.json();
        const msgEl = document.getElementById("chatMessages");
        msgEl.innerHTML = "";
        data.messages.forEach(m => {
          addMsg(m.role, m.content, m.agent_name);
        });
      } catch (e) { log("Load messages error: " + e.message, "log-err"); }
    }

    async function createNewSession() {
      if (!activeRoom && !activeAgent) return;
      try {
        const url = activeRoom ? `/rooms/${activeRoom.id}/sessions` : `/agents/${activeAgent.id}/sessions`;
        const r = await api("POST", url);
        const data = await r.json();
        log("Session created ‚úì", "log-ok");
        activeSession = data;
        loadFiles();
        if (activeRoom) loadSessions("room", activeRoom.id);
        else if (activeAgent) loadSessions("agent", activeAgent.id);
        document.getElementById("chatMessages").innerHTML = "";
      } catch (e) { log("Create session error: " + e.message, "log-err"); }
    }

    async function deleteSession(id, event) {
      if (event) event.stopPropagation();
      if (!confirm("Are you sure you want to delete this session?")) return;
      try {
        const url = activeRoom ? `/rooms/${activeRoom.id}/sessions/${id}` : `/agents/${activeAgent.id}/sessions/${id}`;
        const r = await api("DELETE", url);
        if (r.ok) {
          log("Session deleted ‚úì", "log-ok");
          if (activeSession && activeSession.id === id) {
            activeSession = null;
            document.getElementById("chatMessages").innerHTML = "";
          }
          if (activeRoom) loadSessions("room", activeRoom.id);
          else if (activeAgent) loadSessions("agent", activeAgent.id);
        } else {
          log("Delete session failed: " + r.status, "log-err");
        }
      } catch (e) { log("Delete session error: " + e.message, "log-err"); }
    }

    async function loadRoomAgents(roomId) {
      const section = document.getElementById("roomAgentsSection");
      section.style.display = "block";
      try {
        const r = await api("GET", `/rooms/${roomId}/agents`);
        const data = await r.json();
        const el = document.getElementById("roomAgentList");
        if (!data.length) { el.innerHTML = '<div style="color:var(--text-dim);font-size:12px;">No agents assigned</div>'; return; }
        el.innerHTML = data.map(a => `
      <div class="item-card">
        <div class="name">${a.agent.name}</div>
        <div class="meta">@${a.agent.agent_key} ¬∑ pos ${a.position}</div>
        <div class="delete-btn" onclick="unassignAgent('${a.agent.id}', event)">√ó</div>
      </div>
    `).join("");
      } catch (e) { log("Failed to load room agents: " + e.message, "log-err"); }
    }

    async function unassignAgent(agentId, event) {
      if (event) event.stopPropagation();
      if (!confirm("Remove this agent from the room?")) return;
      try {
        const r = await api("DELETE", `/rooms/${activeRoom.id}/agents/${agentId}`);
        if (r.ok) {
          log("Agent removed ‚úì", "log-ok");
          loadRoomAgents(activeRoom.id);
        } else {
          log("Remove agent failed: " + r.status, "log-err");
        }
      } catch (e) { log("Remove agent error: " + e.message, "log-err"); }
    }

    function populateAssignSelect() {
      const sel = document.getElementById("assignAgentSelect");
      sel.innerHTML = agents.map(a => `<option value="${a.id}">${a.name} (@${a.agent_key})</option>`).join("");
    }

    async function assignAgent() {
      if (!activeRoom) return;
      const agentId = document.getElementById("assignAgentSelect").value;
      const position = parseInt(document.getElementById("assignPosition").value) || 1;
      try {
        const r = await api("POST", `/rooms/${activeRoom.id}/agents`, { agent_id: agentId, position });
        if (r.ok) {
          log("Agent assigned ‚úì", "log-ok");
          hideModal("assignAgentModal");
          loadRoomAgents(activeRoom.id);
        } else {
          const err = await r.json();
          log("Assign failed: " + JSON.stringify(err), "log-err");
        }
      } catch (e) { log("Assign error: " + e.message, "log-err"); }
    }

    /* ‚îÄ‚îÄ‚îÄ Chat ‚îÄ‚îÄ‚îÄ */
    function addMsg(role, text, agentKey) {
      const el = document.getElementById("chatMessages");
      const div = document.createElement("div");
      div.className = "msg " + role;
      if (role === "assistant") {
        div.innerHTML = `<div class="agent-label">${agentKey || 'assistant'}</div><span class="content-text">${escapeHtml(text)}</span>`;
      } else {
        div.textContent = text;
      }
      el.appendChild(div);
      el.scrollTop = el.scrollHeight;
      return div;
    }

    function escapeHtml(s) {
      if (!s) return "";
      return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>");
    }

    async function sendMessage() {
      if (!activeSession) { log("No active session", "log-err"); return; }
      const input = document.getElementById("chatInput");
      const msg = input.value.trim();
      if (!msg) return;
      input.value = "";

      addMsg("user", msg);
      const sendBtn = document.getElementById("sendBtn");
      sendBtn.innerHTML = '<span class="spinner"></span>';
      sendBtn.disabled = true;

      let currentMsgEl = null;
      let currentContentEl = null;

      try {
        BASE = document.getElementById("apiUrl").value.replace(/\/+$/, "");
        const response = await fetch(`${BASE}/sessions/${activeSession.id}/turns/stream`, {
          method: 'POST',
          headers: {
            "Authorization": AUTH,
            "Content-Type": "application/json",
            "Accept": "text/event-stream"
          },
          body: JSON.stringify({ message: msg, model_alias_override: null })
        });

        if (!response.ok) {
          const err = await response.json();
          addMsg("system", "Error: " + (err.detail || JSON.stringify(err)));
          return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split("\n");
          buffer = lines.pop(); // Keep partial line

          for (const line of lines) {
            if (line.startsWith("data: ")) {
              try {
                const data = JSON.parse(line.substring(5).trim());
                if (data.type === 'manager_think') {
                  const el = document.getElementById("chatMessages");
                  const thinkBlock = document.createElement("div");
                  thinkBlock.className = "msg system";
                  thinkBlock.style.backgroundColor = "#1e1e24";
                  thinkBlock.style.borderLeft = "3px solid #6c757d";
                  thinkBlock.style.color = "#a0a5aa";
                  thinkBlock.style.fontStyle = "italic";
                  thinkBlock.style.padding = "8px 12px";

                  if (data.phase === "routing") {
                    thinkBlock.innerHTML = `‚öôÔ∏è <strong>Manager Routing (Round ${data.round})</strong><br>‚Ü≥ <em>Selected Agents: ${data.target_agents.map(a => '@' + a).join(', ')}</em>`;
                  } else if (data.phase === "evaluation") {
                    thinkBlock.innerHTML = `‚öôÔ∏è <strong>Manager Evaluation</strong><br>‚Ü≥ <em>Decision: ${data.decision === 'continue' ? 'Triggering next round' : 'End specialist rounds. Synthesizing final results.'}</em>`;
                  }
                  el.appendChild(thinkBlock);
                  el.scrollTop = el.scrollHeight;
                } else if (data.type === 'agent_start') {
                  currentMsgEl = addMsg("assistant", "", data.agent_name);
                  currentContentEl = currentMsgEl.querySelector(".content-text");
                } else if (data.type === 'chunk') {
                  if (!currentMsgEl) {
                    currentMsgEl = addMsg("assistant", "", "assistant");
                    currentContentEl = currentMsgEl.querySelector(".content-text");
                  }
                  currentContentEl.innerHTML += escapeHtml(data.delta);
                  const el = document.getElementById("chatMessages");
                  el.scrollTop = el.scrollHeight;
                } else if (data.type === 'error') {
                  addMsg("system", "Agent Error: " + data.message);
                }
              } catch (e) { console.error("Parse error", e, line); }
            }
          }
        }
        log("Turn completed ‚úì", "log-ok");
      } catch (e) {
        addMsg("system", "Request failed: " + e.message);
        log("Turn error: " + e.message, "log-err");
      } finally {
        sendBtn.innerHTML = "Send";
        sendBtn.disabled = false;
        input.focus();
      }
    }

    // Auto-connect on load
    window.addEventListener("load", () => setTimeout(checkHealth, 300));

    /* ‚îÄ‚îÄ‚îÄ Files ‚îÄ‚îÄ‚îÄ */
    async function loadFiles() {
      try {
        let url = "";
        if (activeRoom) {
          url = `/rooms/${activeRoom.id}/files`;
        } else if (activeAgent && activeSession) {
          url = `/sessions/${activeSession.id}/files`;
        } else {
          document.getElementById("roomFiles").style.display = "none";
          return;
        }

        const r = await api("GET", url);
        if (!r.ok) { log("Failed to load files", "log-err"); return; }
        const files = await r.json();
        const rf = document.getElementById("roomFiles");
        if (files.length === 0) {
          rf.style.display = "none";
        } else {
          rf.style.display = "flex";
          rf.innerHTML = files.map(f => {
            const statusColor = f.parse_status === 'completed' ? 'var(--green)' : (f.parse_status === 'failed' ? 'var(--red)' : 'var(--orange)');
            return `<div style="background:var(--surface); padding:4px 8px; border-radius:4px; display:flex; align-items:center; gap:5px;" title="ID: ${f.id}\nStatus: ${f.parse_status}">
              <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:${statusColor};"></span>
              ${f.filename}
            </div>`;
          }).join("");
        }
      } catch (e) {
        log("Load files error: " + e.message, "log-err");
      }
    }

    async function uploadFile() {
      if (!activeRoom && !activeSession) return;
      const fileInput = document.getElementById("fileUploadInput");
      const file = fileInput.files[0];
      if (!file) return;

      const fd = new FormData();
      fd.append("file", file);

      try {
        BASE = document.getElementById("apiUrl").value.replace(/\/+$/, "");
        log(`Uploading ${file.name}...`);

        let url = "";
        if (activeRoom) {
          url = BASE + `/rooms/${activeRoom.id}/files`;
        } else if (activeAgent && activeSession) {
          url = BASE + `/sessions/${activeSession.id}/files`;
        }

        const r = await fetch(url, {
          method: "POST",
          headers: { "Authorization": AUTH },
          body: fd
        });
        if (r.ok) {
          log(`File ${file.name} uploaded ‚úì`, "log-ok");
          loadFiles();
        } else {
          const err = await r.json();
          log("Upload failed: " + JSON.stringify(err), "log-err");
        }
      } catch (e) {
        log("Upload error: " + e.message, "log-err");
      } finally {
        fileInput.value = ""; // reset
      }
    }

  </script>
</body>

</html>