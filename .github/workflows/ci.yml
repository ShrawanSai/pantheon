name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  backend-worker:
    name: Backend + Worker Checks
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: https://example.supabase.co
      SUPABASE_SERVICE_ROLE_KEY: dummy-service-role-key
      API_CORS_ALLOWED_ORIGINS: http://localhost:3000,https://pantheon-git-main-shrawan-sais-projects.vercel.app
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff

      - name: Lint (Critical Rules)
        run: |
          ruff check apps/api/app tests scripts/w1_arq_smoke_enqueue.py --select E9,F63,F7,F82

      - name: Unit Tests
        run: |
          python -m unittest discover -s tests -p "test_*.py" -v

      - name: Compile Sanity
        run: |
          python -m compileall apps/api/app scripts

      - name: Worker Import Sanity
        run: |
          python - <<'PY'
          import os
          from apps.api.app.workers.arq_worker import WorkerSettings, redis_settings_from_env

          # Worker settings should import without touching REDIS_URL at import-time.
          assert WorkerSettings.functions, "Worker functions are not registered."

          # Parse-only DSN check; does not attempt network connection.
          os.environ["REDIS_URL"] = "redis://default:dummy@localhost:6379/0"
          settings = redis_settings_from_env()
          assert settings.host == "localhost", f"Unexpected host: {settings.host}"
          print("worker_sanity_ok")
          PY

  frontend:
    name: Frontend Build + Typecheck
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: apps/web/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Build
        run: npm run build
